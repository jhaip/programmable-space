<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Web editor</title>
    <link rel="stylesheet" href="/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.59.1/codemirror.min.css">
    <style>
body {
  display: flex;
  width: 100vw;
  height: 100vh;
  margin: 0;
  padding: 0;
}

#sidebar {
  background-color: #EEE;
  flex: 0 0 200px;
  display: flex;
  flex-direction: column;
  height: 100%;
  overflow: scroll;
}
.rightside {
  flex: 1;
  display: flex;
  flex-direction: column;
}
.menu {
  background-color: #CCF;
}
.menu a {
  margin: 10px;
  line-height: 30px;
}
textarea, .CodeMirror {
  width: 100%;
  height: 100%;
  font-family: monospace;
}
.prog-link {
  padding: 10px;
  border-bottom: 1px solid #CCC
}
.prog-link:hover {
  border-left: 3px solid black;
  cursor: pointer;
}
.prog-link--selected {
  background-color: #BFB;
}
    </style>
  </head>  
  <body>
    <div id="sidebar"></div>
    <div class="rightside">
      <div class="menu">
        <a href="#" onclick="toggleMenu();">Toggle Menu</a>
        <a href="#" onclick="changeFontSize(5);">(+)</a>
        <a href="#" onclick="changeFontSize(-5);">(-)</a>
        <a href="#" onclick="newProgram();">New</a>
        <a href="#" onclick="print();">Print</a>
        <a href="#" onclick="save();">Save</a>
      </div>
      <textarea id="editor" placeholder="// code"></textarea>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.59.1/codemirror.min.js"></script>
    <script>
var db = []; // {name: "X", id: "id", code: "code"}
var selected = 0;
const isSelectedValid = () => selected >= 0 && selected < db.length
var fontSize = 20;

function render() {
  let $sidebar = document.getElementById('sidebar');
  $sidebar.innerHTML = db.map((v, i) => `<a class="prog-link ${(i === selected) ? "prog-link--selected" : ""}" onclick="selectProgram(${i})">${v.name}</a>`).join("");
  let $editor = document.getElementById('editor');
  $editor.value = isSelectedValid() ? db[selected].code.replace(
      new RegExp(String.fromCharCode(9787), 'g'),
      String.fromCharCode(34)
    ) : "nothing selected";
    myCodeMirror.setValue($editor.value);
}

function toggleMenu() {
  var elem = document.getElementById('sidebar');
  elem.style.display = (elem.style.display === "none") ? "flex" : "none";
}

function selectProgram(i) {
  selected = i;
  render();
}

function changeFontSize(v) {
  fontSize += v;
  var elem = document.getElementById('editor');
  elem.style.fontSize = `${fontSize}px`;
  myCodeMirror.getWrapperElement().style.fontSize = `${fontSize}px`;
  myCodeMirror.refresh();
}

function save(evt) {
  if (!isSelectedValid()) {
    alert("selection invalid, cannot save");
    return;
  }
  fetch(`/save`, {
    method: 'post',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({
      'currentTargetId': db[selected].id,
      'currentTargetName': db[selected].name,
      'currentSourceCode': document.getElementById('editor').value,
    })
  }).then(response => console.log(response));
}

function print(evt) {
  if (!isSelectedValid()) {
    alert("selection invalid, cannot save");
    return;
  }
  fetch(`/print`, {
    method: 'post',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({
      'currentTargetId': db[selected].id,
      'currentTargetName': db[selected].name,
    })
  }).then(response => console.log(response));
}

function newProgram(evt) {
  if (!isSelectedValid()) {
    alert("selection invalid, cannot save");
    return;
  }
  fetch(`/new`, {
    method: 'post',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({
      'currentTargetName': db[selected].name,
      'currentSourceCode': document.getElementById('editor').value,
    })
  }).then(response => console.log(response));
}

async function fetchData() {
  try {
    const response = await fetch('/status')
    const myJson = await response.json();
    db = myJson.programs.sort((a,b) =>
      a.name.split("__")[0] < b.name.split("__")[0] ? -1 : 1);
    render();
  } catch (error) {
    console.error(error);
  }
}

var myCodeMirror = CodeMirror.fromTextArea(document.getElementById('editor'), {
  lineNumbers: true,
  gutter: true,
  lineWrapping: true
});
render();
changeFontSize(0);
fetchData();
    </script>
  </body>
</html>
